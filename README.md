# Свой MTProto Proxy для Telegram — Полная инструкция

## Что в комплекте

| Файл | Назначение |
|---|---|
| `setup-vps.sh` | Первоначальная настройка сервера (обновления, Docker, фаервол, fail2ban) |
| `deploy-mtproto.sh` | Развертывание MTProto Proxy в Docker-контейнере |
| `manage.sh` | Управление прокси (старт, стоп, логи, смена секрета, миграция) |

---

## Шаг 1. Аренда VPS

Нужен виртуальный сервер **за пределами России** (Нидерланды, Германия, Финляндия, США).

### Рекомендуемые провайдеры (от дешевых к дорогим)

| Провайдер | Цена | Примечание |
|---|---|---|
| **Aeza.net** | от $3/мес | Принимает RU-карты, серверы в Европе |
| **Timeweb Cloud** | от 199 руб/мес | Русскоязычный, серверы в NL/PL |
| **Hetzner** | от €3.79/мес | Германия/Финляндия, надежный |
| **DigitalOcean** | от $4/мес | Нужна иностранная карта |
| **Vultr** | от $3.50/мес | Нужна иностранная карта |

### Минимальные требования к серверу

- **ОС:** Ubuntu 22.04 / 24.04 или Debian 12
- **RAM:** 512 MB (хватит на сотни пользователей)
- **CPU:** 1 vCPU
- **Диск:** 10 GB SSD
- **Трафик:** от 500 GB/мес (зависит от числа пользователей)

### При заказе

1. Выберите ОС: **Ubuntu 24.04**
2. Выберите локацию: **Нидерланды** или **Германия**
3. Запомните **IP-адрес** и **пароль root** (придут на почту)

---

## Шаг 2. Подключение к серверу

### Windows (через PowerShell или PuTTY)

```powershell
ssh root@ВАШ_IP_АДРЕС
```

### macOS / Linux

```bash
ssh root@ВАШ_IP_АДРЕС
```

---

## Шаг 3. Загрузка скриптов на сервер

На вашем компьютере откройте терминал и выполните:

```bash
scp setup-vps.sh deploy-mtproto.sh manage.sh root@ВАШ_IP:~/
```

Или вручную на сервере:

```bash
# Создайте файлы через nano/vim и вставьте содержимое
nano setup-vps.sh
# (вставить содержимое, сохранить: Ctrl+O, Enter, Ctrl+X)

nano deploy-mtproto.sh
nano manage.sh

# Дать права на выполнение
chmod +x setup-vps.sh deploy-mtproto.sh manage.sh
```

---

## Шаг 4. Настройка сервера

```bash
./setup-vps.sh
```

Скрипт автоматически:
- Обновит систему
- Установит Docker
- Настроит фаервол (откроет порты 22 и 443)
- Настроит fail2ban (защита от брутфорса SSH)

---

## Шаг 5. Регистрация прокси в Telegram

**До запуска deploy-mtproto.sh** нужно получить SECRET:

1. Откройте Telegram
2. Найдите бота **@MTProxybot**
3. Отправьте `/newproxy`
4. Введите IP вашего сервера
5. Введите порт: `443`
6. Бот выдаст вам **SECRET** (секретный ключ) — скопируйте его

### Привязка промо-канала

В том же боте @MTProxybot:
1. Выберите свой прокси из списка
2. Нажмите **"Promote channel"** (Продвигаемый канал)
3. Укажите @username вашего канала
4. Теперь у всех пользователей вашего прокси будет закреплен ваш канал

---

## Шаг 6. Запуск MTProto Proxy

```bash
./deploy-mtproto.sh
```

Скрипт попросит:
1. **SECRET** (полученный от @MTProxybot)
2. **Домен для Fake-TLS** (по умолчанию google.com — просто нажмите Enter)

После запуска вы получите ссылки для подключения.

---

## Шаг 7. Распространение

Отправьте пользователям ссылку вида:

```
https://t.me/proxy?server=ВАШ_IP&port=443&secret=ВАШ_СЕКРЕТ
```

Пользователь нажимает на ссылку -> Telegram предлагает подключить прокси -> Готово.

---

## Управление прокси

```bash
# Статус
./manage.sh status

# Запустить
./manage.sh start

# Остановить
./manage.sh stop

# Перезапустить
./manage.sh restart

# Посмотреть логи
./manage.sh logs

# Показать ссылки для подключения
./manage.sh info

# Обновить Docker-образ
./manage.sh update

# Сменить SECRET
./manage.sh newsecret

# Инструкция по миграции (при блокировке IP)
./manage.sh migrate

# Полное удаление
./manage.sh uninstall
```

---

## Когда РКН заблокирует IP

Это неизбежно. Порядок действий:

1. Арендуйте **новый VPS** у того же или другого провайдера
2. Скопируйте скрипты на новый сервер
3. Запустите `setup-vps.sh` и `deploy-mtproto.sh`
4. В @MTProxybot обновите IP прокси
5. Опубликуйте новую ссылку в своем канале

**Совет:** Всегда публикуйте актуальную ссылку через свой Telegram-канал. Так пользователям не нужно каждый раз получать ссылку лично — они просто заходят в канал и берут новую.

---

## Сколько пользователей потянет

| Пользователей | RAM | CPU | Трафик/мес |
|---|---|---|---|
| до 100 | 512 MB | 1 vCPU | ~100 GB |
| 100-500 | 1 GB | 1 vCPU | ~500 GB |
| 500-2000 | 2 GB | 2 vCPU | ~2 TB |
| 2000+ | 4 GB | 2+ vCPU | ~5+ TB |

MTProto Proxy очень легковесный. Основной расход — трафик.

---

## Безопасность

- Фаервол (UFW) пропускает только SSH (22) и прокси (443)
- fail2ban блокирует IP после 3 неудачных SSH-попыток
- Рекомендуется настроить SSH-ключи вместо паролей
- Fake-TLS маскирует трафик под обычный HTTPS

### Настройка SSH-ключей (рекомендуется)

На **вашем компьютере**:

```bash
ssh-keygen -t ed25519 -C "mtproto-proxy"
ssh-copy-id root@ВАШ_IP
```

После этого можно отключить вход по паролю в `setup-vps.sh` (раскомментировать строки в разделе SSH).

---

## FAQ

**Q: Это VPN?**
A: Нет. MTProto Proxy работает только для Telegram. Для полноценного VPN нужно дополнительно установить WireGuard/OpenVPN на тот же сервер.

**Q: Можно поставить VPN на тот же сервер?**
A: Да. На один VPS можно поставить и MTProto Proxy, и WireGuard. Они не конфликтуют.

**Q: Сколько стоит содержание?**
A: От $3-5/мес за VPS. Это единственный расход.

**Q: Как заработать?**
A: Через промо-канал. Пользователи подключаются бесплатно, взамен видят ваш канал закрепленным. Монетизируйте канал рекламой.
