# MTProto Proxy + Grafana Dashboard

Свой MTProto Proxy для Telegram с личным кабинетом (Grafana) для мониторинга статистики.

## Что это

- **MTProto Proxy** — официальный прокси-сервер Telegram (`telegrammessenger/proxy`) с Fake-TLS маскировкой
- **Grafana Dashboard** — личный кабинет со статистикой (сеть, CPU, RAM, диск)
- **Промо-канал** — ваш Telegram-канал закрепляется у всех пользователей прокси (через TAG)
- **Telegram-бот** — мониторинг, уведомления, управление прокси

## Быстрый старт

### 1. Арендуйте VPS

Нужен сервер **за пределами России** (Нидерланды, Германия, Финляндия).

| Провайдер | Цена | Примечание |
|---|---|---|
| [Aeza.net](https://aeza.net) | от $3/мес | Принимает RU-карты |
| [Timeweb Cloud](https://timeweb.cloud) | от 199 руб/мес | Русскоязычный |
| [Hetzner](https://hetzner.com) | от 3.79 EUR/мес | Надежный |

**Требования:** Ubuntu 22.04+, 512 MB RAM, 1 vCPU

### 2. Получите SECRET и TAG в Telegram

1. Откройте бота **@MTProxybot**
2. Отправьте `/newproxy`
3. Введите **IP сервера** и **порт 443**
4. Бот попросит **secret** — сгенерируйте: `openssl rand -hex 16`
5. Скопируйте **proxy tag** (TAG) который выдаст бот
6. Нажмите **"Promoted Channel"** и укажите свой канал

### 3. Установите на сервер

```bash
# Скачать
git clone https://github.com/kalininlive/my-super-vpn.git
cd my-super-vpn

# Настроить сервер (Docker, фаервол, fail2ban)
chmod +x setup-vps.sh && ./setup-vps.sh

# Запустить прокси + дашборд
chmod +x with-dashboard/deploy.sh && cd with-dashboard && ./deploy.sh
```

Скрипт спросит **SECRET**, **TAG**, настроит Fake-TLS и поднимет 4 контейнера:
- `mtproto-proxy` — прокси-сервер
- `node-exporter` — сбор метрик сервера
- `prometheus` — хранилище метрик
- `grafana` — дашборд

### 4. Готово!

- **Прокси:** `tg://proxy?server=ВАШ_IP&port=443&secret=ВАШ_СЕКРЕТ`
- **Grafana:** `http://ВАШ_IP:3000`

---

## Привязка домена (вместо IP)

Чтобы пользователи не видели ваш IP в ссылке:

### Шаг 1. Купите домен

Любой регистратор: Namecheap, Cloudflare, reg.ru и т.д.

### Шаг 2. Добавьте DNS-записи

В панели управления доменом создайте A-записи:

| Тип | Имя | Значение | TTL |
|---|---|---|---|
| A | `proxy` | `IP_ВАШЕГО_СЕРВЕРА` | 300 |
| A | `dashboard` | `IP_ВАШЕГО_СЕРВЕРА` | 300 |

**Важно:** Если используете Cloudflare — выключите проксирование (серая иконка облака, DNS-only). Оранжевое облако сломает MTProto.

### Шаг 3. Используйте домен в ссылке

```
tg://proxy?server=proxy.ваш-домен.com&port=443&secret=ВАШ_СЕКРЕТ
```

Grafana будет доступна по: `http://dashboard.ваш-домен.com:3000`

### Преимущества домена

- Пользователи не видят IP
- При смене сервера (блокировка РКН) — просто обновите A-запись
- Не нужно раздавать новые ссылки

---

## Промо-канал (спонсорский канал)

Чтобы ваш канал закреплялся у всех пользователей прокси:

1. Откройте **@MTProxybot** в Telegram
2. Выберите свой прокси из списка
3. Нажмите **"Promoted Channel"**
4. Укажите `@username` вашего канала
5. Готово — у всех пользователей канал будет закреплен вверху

**Важно:** Промо-канал работает через TAG. При установке (`deploy.sh`) скрипт спросит TAG от @MTProxybot. Без TAG промо-канал работать не будет.

---

## Grafana Dashboard

Личный кабинет показывает в реальном времени:

| Панель | Метрика |
|---|---|
| CPU | Загрузка процессора сервера |
| RAM | Использование оперативной памяти |
| Disk | Занятое дисковое пространство |
| System Load | Нагрузка на систему (1m/5m/15m) |
| Скорость трафика | Входящий/исходящий байт/сек |
| Общий объём трафика | Суммарный трафик за период |
| Пакеты в секунду | Сетевые пакеты входящие/исходящие |
| Ошибки сети | Ошибки приёма/отправки |

---

## Управление

```bash
cd /opt/mtproto-dashboard

# Логи
docker compose logs -f mtproto-proxy

# Перезапуск
docker compose restart

# Остановка
docker compose down

# Запуск
docker compose up -d
```

---

## Когда РКН заблокирует IP

1. Арендуйте **новый VPS**
2. Повторите установку (шаг 3)
3. **Если есть домен** — просто обновите A-запись на новый IP
4. **Если нет домена** — опубликуйте новую ссылку в своем канале
5. В @MTProxybot обновите IP прокси

---

## Структура проекта

```
.
├── setup-vps.sh                           # Настройка сервера
├── deploy-mtproto.sh                      # Простой деплой (без дашборда)
├── manage.sh                              # CLI управление
├── bot/                                   # Telegram-бот мониторинга
│   ├── install-bot.sh                     # Установщик бота
│   └── monitor-bot.sh                     # Скрипт бота
└── with-dashboard/                        # Полный стек с Grafana
    ├── deploy.sh                          # Деплой с дашбордом
    ├── docker-compose.yml                 # Proxy + Node Exporter + Prometheus + Grafana
    ├── prometheus/
    │   └── prometheus.yml                 # Сбор метрик
    └── grafana/
        ├── provisioning/
        │   ├── datasources/datasource.yml
        │   └── dashboards/dashboards.yml
        └── dashboards/
            └── mtproto-proxy.json         # Готовый дашборд
```

---

## Telegram-бот мониторинга

Бот для управления прокси и получения уведомлений о проблемах прямо в Telegram.

### Команды

| Команда | Описание |
|---|---|
| `/status` | Статус всех сервисов (Proxy, Prometheus, Grafana, Node Exporter), uptime, CPU, RAM, диск |
| `/restart` | Перезапуск только MTProto Proxy |
| `/restartall` | Перезапуск всех сервисов |
| `/logs` | Последние 15 строк логов прокси |
| `/traffic` | Статистика: CPU/RAM контейнера, входящий/исходящий трафик |
| `/ip` | IP сервера и готовая ссылка прокси |
| `/help` | Список всех команд |

### Автоматические уведомления

Бот проверяет состояние каждые 30 секунд и сам отправляет уведомления:

- **Прокси упал** — мгновенное сообщение с предложением перезапустить (`/restart`)
- **Прокси восстановился** — подтверждение что всё снова работает
- **CPU > 80%** — предупреждение о высокой нагрузке
- **RAM > 90%** — предупреждение о нехватке памяти

### Установка бота

**1. Создайте бота в Telegram:**
- Откройте **@BotFather** → `/newbot`
- Придумайте имя и username
- Скопируйте токен

**2. Запустите установщик на сервере:**

```bash
cd ~/my-super-vpn/bot
chmod +x install-bot.sh monitor-bot.sh && ./install-bot.sh
```

Скрипт попросит:
1. Вставить **токен** от BotFather
2. Отправить любое сообщение боту в Telegram (для определения Chat ID)
3. Выбрать интервал проверки (по умолчанию 30 сек)

Бот установится как systemd-сервис и запустится автоматически.

### Управление ботом

```bash
systemctl status mtproto-monitor-bot    # Статус
systemctl restart mtproto-monitor-bot   # Перезапуск
systemctl stop mtproto-monitor-bot      # Остановка
journalctl -u mtproto-monitor-bot -f    # Логи бота в реальном времени
```

### Обновление бота

При обновлении файлов через git:

```bash
cd ~/my-super-vpn && git stash && git pull
cp bot/monitor-bot.sh /opt/mtproto-bot/monitor-bot.sh
systemctl restart mtproto-monitor-bot
```

---

## FAQ

**Это VPN?**
Нет. MTProto Proxy работает только для Telegram.

**Можно поставить VPN на тот же сервер?**
Да. WireGuard/OpenVPN не конфликтуют с MTProto Proxy.

**Сколько стоит?**
От $3-5/мес за VPS.

**Сколько пользователей потянет?**

| Пользователей | RAM | Трафик/мес |
|---|---|---|
| до 100 | 512 MB | ~100 GB |
| 100-500 | 1 GB | ~500 GB |
| 500-2000 | 2 GB | ~2 TB |
